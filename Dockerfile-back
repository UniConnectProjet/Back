# Utiliser une image qui contient à la fois PHP-FPM et NGINX
FROM webdevops/php-nginx:8.2

# Installer les dépendances système utiles pour Symfony + extensions PHP
RUN apt-get update && apt-get install -y \
    git \
    unzip \
    curl \
    libpq-dev \
    libzip-dev \
    zip \
    libonig-dev \
    libxml2-dev \
    default-mysql-client \
    && docker-php-ext-install pdo pdo_mysql pdo_pgsql zip

# Définir le répertoire de travail
WORKDIR /app

# Copier d'abord les fichiers composer pour optimiser le cache
COPY composer.json composer.lock ./
RUN if [ -f composer.json ]; then \
    COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader --no-scripts; \
    fi

# Puis copier le reste des fichiers du projet
COPY . .

# Marquer ce dossier comme sûr (évite les erreurs Git)
RUN git config --global --add safe.directory /app

# Configurer les permissions
RUN chown -R application:application /app

# Créer le script d'entrée avec débogage
RUN echo '#!/bin/bash\n\
# Logs de débogage\n\
echo "Starting application..."\n\
echo "PORT=$PORT"\n\
\n\
# On force NGINX à écouter sur le port 9000\n\
sed -i "s/listen \${PORT};/listen 9000;/g" /opt/docker/etc/nginx/vhost.conf\n\
\n\
# Exécuter les migrations si nécessaire (optionnel)\n\
# php /app/bin/console doctrine:migrations:migrate --no-interaction\n\
\n\
# Effacer le cache Symfony (optionnel)\n\
php /app/bin/console cache:clear --env=prod\n\
\n\
# Démarrer le superviseur qui lancera NGINX et PHP-FPM\n\
exec supervisord\n' > /entrypoint.sh \
    && chmod +x /entrypoint.sh

# Créer la configuration NGINX
RUN echo 'server {\n\
    listen ${PORT};\n\
    server_name _;\n\
    root /app/public;\n\
    index index.php;\n\
\n\
    client_max_body_size 100M;\n\
\n\
    location / {\n\
        try_files $uri /index.php$is_args$args;\n\
    }\n\
\n\
    location ~ \.php$ {\n\
        fastcgi_split_path_info ^(.+\.php)(/.+)$;\n\
        fastcgi_pass 127.0.0.1:9000;\n\
        fastcgi_index index.php;\n\
        include fastcgi_params;\n\
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\
        fastcgi_param DOCUMENT_ROOT $document_root;\n\
    }\n\
\n\
    location ~ /\.ht {\n\
        deny all;\n\
    }\n\
}\n' > /opt/docker/etc/nginx/vhost.conf

# Exposer le port que Railway attend
ENV PORT=9000
EXPOSE 9000

# Point d'entrée pour lancer NGINX et PHP-FPM
ENTRYPOINT ["/entrypoint.sh"]